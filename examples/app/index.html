<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>KMK Live</title>
    <style>
      body { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; margin: 18px; }
      h2 { margin-top: 24px; }
      .row { display: flex; gap: 10px; flex-wrap: wrap; margin: 8px 0; align-items: center; }
      label { display: inline-grid; grid-template-columns: 140px 1fr; align-items: center; gap: 8px; }
      input, select, button { padding: 6px 8px; }
      label > input[type=text], label > input[type=password], label > select { min-width: 260px; }
      @media (max-width: 560px) {
        label { grid-template-columns: 1fr; }
        label > input[type=text], label > input[type=password], label > select { min-width: 0; width: 100%; }
      }
      .card { border: 1px solid #ddd; padding: 10px; border-radius: 6px; margin: 8px 0; }
      .muted { color: #666; }
      .ok { color: #0a0; }
      .err { color: #c00; }
      .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 10px; }
      .hidden { display: none; }
      code { background:#f6f8fa; padding:2px 4px; border-radius:4px; }
    </style>
  </head>
  <body>
    <h1>KMK Live</h1>

    <div class="card">
      <div class="row">
        <label>Email <input id="email" type="text" placeholder="you@example.com" /></label>
        <label>Password <input id="password" type="password" placeholder="password" /></label>
        <button id="login">Login</button>
        <span id="authStatus" class="muted"></span>
      </div>
      <div class="row">
        <small class="muted">Signed-in users can browse and join live streams.</small>
      </div>
    </div>

    <div class="card">
      <h2>Active Streams</h2>
      <div id="activeList" class="grid"></div>
      <div id="activeEmpty" class="muted">No active streams</div>
    </div>

    <script>
      // Settings are stored silently; defaults derived from current origin
      const DEFAULTS = (() => {
        const proto = location.protocol; // http: or https:
        const host = location.hostname; // ip/hostname
        const tokenBase = `${proto}//${location.host}`; // same origin as this page
        // assume FastAPI on :8000 at same host
        const apiBase = `${proto}//${host}:8000`;
        return { apiBase, tokBase: tokenBase };
      })();

      // Restore saved settings
      (function init() {
        const saved = JSON.parse(localStorage.getItem('streammeon_state') || '{}');
        // Implicit defaults if missing
        if (!saved.apiBase) saved.apiBase = DEFAULTS.apiBase;
        if (!saved.tokBase) saved.tokBase = DEFAULTS.tokBase;
        // Persist defaults so viewer/vendor pages can read them
        localStorage.setItem('streammeon_state', JSON.stringify(saved));
        if (saved.user) setUser(saved.user, saved.jwt);
        refreshActive();
        setInterval(refreshActive, 5000);
      })();

      function saveState(extras={}) {
        const cur = JSON.parse(localStorage.getItem('streammeon_state') || '{}');
        const next = { ...cur, ...DEFAULTS, ...extras };
        localStorage.setItem('streammeon_state', JSON.stringify(next));
      }

      function setUser(user, jwt) {
        window.currentUser = user || null;
        window.jwt = jwt || null;
        const status = document.getElementById('authStatus');
        if (user && jwt) {
          status.textContent = `Logged in as ${user.name} (${user.role})`;
          status.className = 'ok';
          // nothing else to show for vendors here; dedicated live page exists under /app/live.html
        } else {
          status.textContent = 'Not logged in';
          status.className = 'muted';
        }
      }

      async function login() {
        const api = (JSON.parse(localStorage.getItem('streammeon_state')||'{}').apiBase) || DEFAULTS.apiBase;
        const payload = { email: email.value.trim(), password: password.value };
        const res = await fetch(`${api}/auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!res.ok) { authStatus.textContent = 'Login failed'; authStatus.className = 'err'; return; }
        const data = await res.json();
        setUser(data.user, data.access_token);
        saveState({ jwt: data.access_token, user: data.user });
      }

      async function refreshActive() {
        const api = (JSON.parse(localStorage.getItem('streammeon_state')||'{}').apiBase) || DEFAULTS.apiBase;
        try {
          const res = await fetch(`${api}/live/sessions/active`);
          if (!res.ok) throw new Error('active failed');
          const data = await res.json();
          renderActive(data.items || []);
        } catch (e) {
          // ignore temporary errors
        }
      }

      function renderActive(items) {
        const container = document.getElementById('activeList');
        const empty = document.getElementById('activeEmpty');
        container.innerHTML = '';
        if (!items.length) { empty.classList.remove('hidden'); return; }
        empty.classList.add('hidden');
        for (const it of items) {
          const card = document.createElement('div');
          card.className = 'card';
          const url = new URL('./viewer.html', location.href); url.searchParams.set('sid', it.session_id);
          const secs = Number(it.live_duration_seconds||0);
          const h = String(Math.floor(secs/3600)).padStart(2,'0');
          const m = String(Math.floor((secs%3600)/60)).padStart(2,'0');
          const s = String(secs%60).padStart(2,'0');
          card.innerHTML = `
            <div><strong>${it.title}</strong></div>
            <div class="muted">Vendor: ${it.vendor?.name || 'n/a'}</div>
            <div>Viewers: ${it.viewer_count} â€¢ Duration: ${h}:${m}:${s}</div>
            <div><a href="${url.toString()}" target="_blank">Join</a></div>
          `;
          container.appendChild(card);
        }
      }

      document.getElementById('login').onclick = login;
    </script>
  </body>
  </html>
